# 3. OAuth (Open Authentification)



### 1. OAuth

* 다른 서비스를 통해 해당 API 사용 권한을 인증받는 공통 수단
* 타사의 계정에 대한 정보를 공유하도록 허용해줌
* 흔히, 카카오 로그인/네이버 로그인/ 구글 로그인 기능에서 쓰이는 인증 절차가 OAuth
* 배경
  * 개인정보를 여러 서비스에 입력하면 피싱에 노출될 수 있음
  * 따라서 ID/PW 제공하지 않고 서비스 이용하기 위함
* 장점
  * 사용자는 소비자에 ID/PW 알려주지 않아도 됨
  * 소비자는 사용자의 ID/PW 정보 몰라도, 엑세스토큰만 가지고 허가 받은 API에 접근 가능
* 단점
  * 전자 서명으로 암호화하여 번거로움
  * 인증 토큰을 발급받으면 계속 사용 가능하기 때문에 긴 시간 사용할 경우 공격에 취약



### 2. 용어(1.0/2.0)

* 사용자/자원 소유자 (User/Resource Owner)
  * 계정을 가진 개인
* 서비스 제공자/자원 서버 (Service Provider/ResourceServer)
  * OAuth를 통해 접근을 지원하는 웹 애플리케이션
  * 카카오, 네이버, 구글 등
* 소비자/클라이언트(Consumer/Client)
  * OAuth를 통해 서비스 제공자에게 접근하는 웹 사이트 or 애플리케이션
* 접근 토큰 (Access Token)
  * 소비자가 사용자를 대신하여 보호된 리소스에 접근하는데 사용되는 값



### 3. OAuth 1.0 인증 과정

1. 유저가 소비자 서비스에서, 서비스 제공자 기능 사용하려는 요청 (ex. 카카오로 로그인)
2. **소비자가** 서비스 제공자에게 **요청 토큰 요청**
3. 소비자가 => 자신이 유저로부터 **권한 부여 요청 받았음을 인증하기 위해 자신의 디지털 서명**을 만들어 => 서비스 제공자에게 전달
4. 서비스 제공자는 **권한 부여 요청 확인했음을 알리는 Request Token**을 소비자에게 발급
5. 소비자는 요청 토큰과 + 유저 요청을 => 서비스 제공자의 인가 화면으로 리다이렉트
6. 인가화면에서 사용자는 소비자에게 권한 부여(**Grant**)
7. **권한 부여 확인 코드 받은 소비자**는 => **서명** 만들어 => 서비스 제공자에게 보냄
8. 서비스 제공자는 서명 확인 후, 유저만 접근할 수 있었던 보호 자원에 대한 **Access Token을 소비자**에게 발급
9. 이후 **소비자는 엑세스 토큰으로 유저 대신** 서비스 제공자에게 요청하여 보호 자원 **접근**

  

### 4. OAuth 2.0

* 다양한 인증 방식 제공
* 용어 변경
  * 사용자 => 자원 소유자(Resource Owner)
  * 소비자 => 클라이언트
  * 서비스 제공자 => 자원 서버/권한 서버
* 인증 절차 간소화 
  * 기능 단순화 & 확장성을 위해
  * API 호출 시, 인증을 위한 디지털 서명 기반 암호화를 => HTTPS를 의무화하여 암호화 맡김
* Refresh Token으로 엑세스 토큰 갱신 가능
  * 접근 토큰 재발급하기 위한 재발급 토큰
  * 접근 토큰의 유효기간 단축하여 보안 개선



### 5. OAuth 2.0 인증과정

1. 자원을 가진 서버에서 
   * Client id 설정
     * 어떤 클라이언트에서 OAuth인증 요청하는지 식별
   * Authorized redirect URLs로 Client URL 설정
     * 인가 코드(임시 비번)를 전달할 주소
     * 여기로 자원 정보를 POST로 전송
2. 그 후 서버는 해당 클라이언트에 Client Secret(비밀 키) 발급
3. 자원 소유자가 Client에서, 해당 자원 접근하려고 요청 (ex. 카카오로 로그인)
4. Client는 => **권한 부여 승인코드를 요청** => 권한 서버에게 **in HTTPS 요청**
   * 요청에 포함되는 파라미터
     * **Client_id**, Redirect_url, 응답 형식
5. Client는 리소스 어너의 브라우저를 => **권한 서버의 화면으로 리다이렉트**
6. Resource Owner가 계정 정보 입력하고, 바르다면 => **자원 소유자는 Client에 권한 Grant**
7.  **권한 서버는 => 인가코드를 => Client에게** 줌
8. Client는 인가코드를 보내며 **Access Token을 => 권한 서버에게** 요청
   * 요청에 포함되는 파라미터
     * Client_id, Client_Secret, Redirect_url, **인가 코드**
9. 권한 서버는 => **Access Token을 => 클라이언트에게** 발급
10. 이 후, 클라이언트는 유저를 대신하여, **엑세스 토큰과 함께 요청을  => 자원 서버에게** 보냄